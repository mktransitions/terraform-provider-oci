#!/bin/bash
## Bastion script to drive all provisioning tasks 
## by Zachary Smith (Zachary.Smith@oracle.com) 
## Last Update - April 2018
##

### Firewall Configuration
## Set this flag to 1 to enable host firewall, 0 to disable
firewall_on="1"

#### MAIN EXECUTION BEGIN ####
cd /home/opc/

### ISCSI Block Device Setup
 iscsiadm -m discoverydb -D -t sendtargets -p 169.254.2.2:3260
 iscsiadm -m node -l
 iscsiadm -m node -n node.startup -v automatic

### DISK SETUP
n=0
for disk in ` cat /proc/partitions | grep -iv sda | sed 1,2d | gawk '{print $4}'`; do
	echo -e "\nProcessing /dev/$disk"
	 mke2fs -F -t ext4 -b 4096 -E lazy_itable_init=1 -O sparse_super,dir_index,extent,has_journal,uninit_bg -m1 /dev/$disk
	 mkdir -p /data$n
	 mount -o noatime,barrier=1 -t ext4 /dev/$disk /data$n
	UUID=` lsblk -no UUID /dev/$disk`
	echo "UUID=$UUID   /data$n    ext4   defaults,noatime,discard,barrier=0 0 1" |  tee -a /etc/fstab
	 /sbin/tune2fs -i0 -c0 /dev/$disk
	n=$((n+1))
done;

### Tune Host
## Install and start NTP
yum install ntp.x86_64 java-1.8.0-openjdk.x86_64 -y
cat /etc/ntp.conf | grep -iv rhel >> /tmp/ntp.conf
echo "server 169.254.169.254 iburst" >> /tmp/ntp.conf
cp /tmp/ntp.conf /etc/ntp.conf
rm -f /tmp/ntp.conf
systemctl stop ntpd
ntpdate 169.254.169.254
systemctl start ntpd
systemctl enable ntpd
systemctl stop chronyd
systemctl disable chronyd

## Disable Transparent Huge Pages
echo never | tee -a /sys/kernel/mm/transparent_hugepage/enabled
echo "echo never | tee -a /sys/kernel/mm/transparent_hugepage/enabled" | tee -a /etc/rc.local

## Set vm.swappiness to 1
echo vm.swappiness=1 | tee -a /etc/sysctl.conf
echo 1 | tee /proc/sys/vm/swappiness

## Tune system network performance
echo net.ipv4.tcp_timestamps=0 >> /etc/sysctl.conf
echo net.ipv4.tcp_sack=1 >> /etc/sysctl.conf
echo net.core.rmem_max=4194304 >> /etc/sysctl.conf
echo net.core.wmem_max=4194304 >> /etc/sysctl.conf
echo net.core.rmem_default=4194304 >> /etc/sysctl.conf
echo net.core.wmem_default=4194304 >> /etc/sysctl.conf
echo net.core.optmem_max=4194304 >> /etc/sysctl.conf
echo net.ipv4.tcp_rmem="4096 87380 4194304" >> /etc/sysctl.conf
echo net.ipv4.tcp_wmem="4096 65536 4194304" >> /etc/sysctl.conf
echo net.ipv4.tcp_low_latency=1 >> /etc/sysctl.conf

## Tune File System options
sed -i "s/defaults        1 1/defaults,noatime        0 0/" /etc/fstab


##sed -i "s/MASTERIP/$master_ip/g" startup.sh
## Firewall Setup
if [ $firewall_on = "1" ]; then
        echo -e "\tSetting up Firewall Ports"
               	echo -e "Port 7180"
               	 firewall-cmd --zone=public --add-port=7180/tcp
		echo -e "Port 19888"
		 firewall-cmd --zone=public --add-port=19888/tcp
		echo -e "Port 8088"
		 firewall-cmd --zone=public --add-port=8088/tcp
                 firewall-cmd --runtime-to-permanent
		echo -e "DONE"
        else
                systemctl stop firewalld
                systemctl disable firewalld
	fi
echo -e "Running CDH Manager Setup..."

## CMS installer
# Set cdh_version to "5" to use latest version, otherwise custom version can be specified
cdh_version="5"
rpm --import http://archive.cloudera.com/cm5/redhat/7/x86_64/cm/RPM-GPG-KEY-cloudera
wget http://archive.cloudera.com/cm5/redhat/7/x86_64/cm/cloudera-manager.repo -O /etc/yum.repos.d/cloudera-manager.repo
if [ $cdh_version = "5" ]; then
        sleep .001
else
        sed -i "s/cm\/5/cm\/${cdh_version}/g" /etc/yum.repos.d/cloudera-manager.repo
fi

yum install -y oracle-j2sdk* cloudera-manager-daemons cloudera-manager-server

echo -e "CDH Manager Setup Complete... Starting CDH provisioning via SCM..."

domain=`cat /etc/resolv.conf  | grep search | gawk '{print $3}'`
master_ip=`dig +short cdh-sandbox.${domain}`
## Invoke SCM bootstrapping and initialization 

User="root"
LOG_FILE="/home/opc/cdh_setup.log"
ssh_keypath="/home/opc/.ssh/id_rsa"
VMSIZE="VM.Standard2.8"

##
## MAIN CLUSTER CONFIGURATION - MODIFY THESE VARIABLES PRIOR TO INSTALLATION
##

ClusterName="TestCluster"
cmUser="cdhadmin"
cmPassword="somepassword"
EMAILADDRESS="someguy@oracle.com"
BUSINESSPHONE="8675309"
FIRSTNAME="Big"
LASTNAME="Data"
JOBROLE="root"
JOBFUNCTION="root"
COMPANY="Oracle"

## 
## END CONFIGURATION
##

## MAIN
echo "Installing Postgres, Python, Paramiko..."
yum install postgresql-server python-pip python-paramiko.noarch -y
echo "Configuring Postgres Database..."
bash /home/opc/install-postgresql.sh >> /var/log/postgresql_cdh_setup.log
echo "Installing CM API via PIP plus dependencies..."
pip install pyopenssl ndg-httpsclient pyasn1
yum install libffi-devel -y
pip install cm_api
echo "Starting SCM Server..."
service cloudera-scm-server start 
## Execute Python cluster setup
mkdir -p /log/cloudera
echo -e "Setup ready to execute... Running Cluster Initialization Script..."
python /home/opc/cmx.py -n "$ClusterName" -u "$User" -m "$master_ip" -w "$master_ip" -c "$cmUser" -s "$cmPassword" -e -r "$EMAILADDRESS" -b "$BUSINESSPHONE" -f "$FIRSTNAME" -t "$LASTNAME" -o "$JOBROLE" -i "$JOBFUNCTION" -y "$COMPANY" -v "$VMSIZE" -k "$ssh_keypath"

